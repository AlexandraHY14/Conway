<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>

  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/criacaoVeiculo.css" />
  <link rel="stylesheet" href="css/menuDashboard.css" />
  <link rel="stylesheet" href="css/modal4.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/89d28f01ec.js" crossorigin="anonymous"></script>
</head>

<body>
  <!--Começo do header-->

  <div class="navbar">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
      <path
        d="M224 0C348.8 0 448 35.2 448 80V96 416c0 17.7-14.3 32-32 32v32c0 17.7-14.3 32-32 32H352c-17.7 0-32-14.3-32-32V448H128v32c0 17.7-14.3 32-32 32H64c-17.7 0-32-14.3-32-32l0-32c-17.7 0-32-14.3-32-32V96 80C0 35.2 99.2 0 224 0zM64 128V256c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V128c0-17.7-14.3-32-32-32H96c-17.7 0-32 14.3-32 32zM80 400a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm288 0a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"
        fill="rgb(105,80,60)" />
    </svg>

    <h1>Adicionar Rota</h1>
  </div>

  <div class="header">
    <div class="container">
      <ul>
        <li><a href=""> CONFIGURAÇÕES </a></li>
        <li><a href="menuDashboard.html"> VOLTAR </a></li>
      </ul>
    </div>
  </div>
  <!--Fim do header-->

  <!-- Conteúdo - Gráficos -->
  <main>
    <div class="conteudos">
      <div class="caixaContent">
        <div class="content">
          <div class="formRotas" style="display: flex;">
            <label for="iptCodRota">
              <p>Nome da rota:</p>
              <input type="text" placeholder="0B19" id="iptCodRota" />
              <p>Tipo de Linha:</p>
              <input type="text" id="iptTipoLinha" placeholder="10" />
              <p>Ponto Inicial:</p>
              <input type="text" id="iptPontoInicial" placeholder="Ex: Bairro Campestre - Rodoviária" />
              <p>Ponto Final:</p>
              <input type="text" id="iptPontoFinal" placeholder="Ex: Jardim Aclimação" />
              <button onclick="cadastrarLinha()">Cadastrar Llinha</button>
            </label>

            <!-- Início do Modal para cadastrar pontos -->
            <!-- <div class="modal modal4">
              <div class="modal__inner"> -->
                <div class="container">
                  <span class="addRota">
                    <div class="div_ipt">
                      <label>Cadastrar Pontos</label>
                      <input class="ipt_func" placeholder="Logradouro" id="ipt_logradouro" />
                      <span id="cepNumero">
                        <input class="ipt_func" placeholder="CEP" id="ipt_cep" />
                        <input class="ipt_func" placeholder="Número" id="ipt_num" />
                      </span>
                      <br />
                    </div>

                    <div class="div_ipt">
                      <label>Coordenadas geográficas</label>
                      <p>(Opcional)</p>
                      <span id="coordenadas">
                        <input class="ipt_func" placeholder="X" id="ipt_coordX" />
                        <input class="ipt_func" placeholder="Y" id="ipt_coordY" />
                      </span>
                    </div>

                    <div class="btnRota">
                      <button onclick="cadastrarPonto()">Adicionar</button>
                    </div>
                  </span>
                </div>
              <!-- </div>
            </div> -->

            <div class="cadPontoLinha">
              <label>Cadastrar Pontos na Linha</label>
              <div class="datalistPonto">
                <input list="browsers" name="browser" id="browser">
                <datalist id="browsers">
                  <!-- <option value="Ponto01" id="testePontos"></option>  -->
                  <!-- <option value="Ponto02"></option>
                      <option value="Ponto03"></option>
                      <option value="Ponto04"></option>
                      <option value="Ponto05"></option> -->
                </datalist>
                <button onclick="addPonto()">Adicionar Ponto a Linha</button>
                <label>Pontos Cadastrados</label>
                <div id="pontosAdicionados"></div>
              </div>
            </div>
            <!-- Fim do Modal para cadastrar pontos -->
          </div>




          <div class="lista-rotas">

          </div>
        </div>
        <div class="btn-area">
          <button onclick="addPontoLinha()"><b>Adicionar+</b></button>

        </div>
      </div>

      <!-- Conteúdo - Veículos -->
      <aside>
        <div class="imgHeader">
          <img src="images/transpass.png" alt="" />
        </div>

        <div class="funcionarios">
          <p>Suas Rotas:</p>
          <ul>
            <li><a href="alterarVeiculo.html"> 775N-10 </a></li>
            <li><a href="alterarVeiculo.html"> 8707-10, 8707-31 </a></li>
            <li><a href="alterarVeiculo.html"> 715M-10, 748R-10 </a></li>
          </ul>

          <p><b>Clique na rota para gerenciá-la ou excluí-la</b></p>
        </div>
      </aside>
      <!-- Fim do Conteúdo - Veículos -->
    </div>


  </main>
  <!-- Fim do Conteúdo - Gráficos -->
</body>

</html>
<script>

var pontos = [];
var vetorPonto = [];
var vetorPontoLimpo = [];
var vetorIdPontoSelect = [];

selectPonto();

function selectPonto() { //ATUALIZAR DATALIST DOS PONTOS


fetch("/ponto/listar").then(function (resposta) {
  if (resposta.ok) {
    if (resposta.status == 204) {
      var feed = document.getElementById("browsers");
      var mensagem = document.createElement("option");
      mensagem.innerHTML = "Nenhum resultado encontrado." //SE NÂO APARECER NADA, MUDAR AQUI
      feed.appendChild(mensagem);
      throw "Nenhum resultado encontrado!!";
    }

    resposta.json().then(function (resposta) {
      console.log("Dados recebidos: ", JSON.stringify(resposta));
      pontos = resposta;

      var feed = document.getElementById("browsers");
      feed.innerHTML = "";
      for (let i = 0; i < resposta.length; i++) {
        var publicacao = resposta[i];

        var opcao = document.createElement("option");

        opcao.innerHTML = `${publicacao.logradouro}, ${publicacao.numNaRua}`;

        feed.appendChild(opcao);
      }
    });
  } else {
    throw ("Houve um erro na API")
  }
}).catch(function (resposta) {
  console.error(resposta);
});
}

function cadastrarPonto() {
    var logradouroVar = ipt_logradouro.value;
    var cepVar = ipt_cep.value;
    var numVar = ipt_num.value;
    var coordXVar = ipt_coordX.value;
    var coordYVar = ipt_coordY.value;

    if(coordXVar == '' || coordYVar == ''){
      coordXVar = null;
      coordYVar = null;
    }

    fetch("/ponto/cadastrarPonto", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        cepServer: cepVar,
        logradouroServer: logradouroVar,
        numServer: numVar,
        coordYServer: coordYVar,
        coordXServer: coordXVar,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          alert("Cadastro REALIZADO com Sucesso!!!");

          // setTimeout(() => {
          //   window.location = "menuDashboard.html";
          // }, "2000")

          selectPonto();
        } else {
          throw "Houve um ERRO ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;
  }

  function cadastrarLinha() {
    var nomeRotaVar = iptCodRota.value;
    var tipoLinhaVar = iptTipoLinha.value;
    var pontoInicialVar = iptPontoInicial.value;
    var pontoFinalVar = iptPontoFinal.value;
    var fkEmpresa = 1;

    // Validações - Para fazer...

    fetch("/linha/cadastrarLinha", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({

        nomeRotaServer: nomeRotaVar,
        tipoLinhaServer: tipoLinhaVar,
        pontoInicialServer: pontoInicialVar,
        pontoFinalServer: pontoFinalVar,
        fkEmpresaServer: fkEmpresa
      })
    }).then(function (resposta) {
      console.log("resposta: ", resposta);

      if (resposta.ok) {
        alert("Cadastro REALIZADO com Sucesso!!!")

         selectLinha();
        // window.location.href = "addPontoLinha.html";

        //sessionStorage.ID_LINHA = resposta.idLinha;
        // sessionStorage.NOME_LINHA = nomeRotaVar;
        // sessionStorage.TIPO_LINHA = tipoLinhaVar;
        // sessionStorage.PONTO_INICIAL = pontoInicialVar;
        // sessionStorage.PONTO_FINAL = pontoFinalVar;

      } else {
        throw ("Houve um ERRO ao tentar realizar o cadastro!");
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });

    return false;
  }

  function selectLinha() {
    var nomeRotaVar = iptCodRota.value;

    fetch(`/linha/listarPorCodigo/${nomeRotaVar}`, {
      cache: "no-store",
    }).then(function (resposta){
      console.log("ESTOU NO THEN DO SELECTLINHA()!!!!!!!!!!!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.ID_LINHA = json.idLinha;
        });
      } else {
        console.log("Houve um erro ao tentar realizar o SELECT!!!!!!!!!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
    })
    return false;
  }

  var inserir = true;

  function addPonto(){

    for (var i = 0; i < vetorPonto.length; i++) {
      if(browser.value == vetorPonto[i]){
        inserir = false;
      }
      else{
        inserir = true;
      }
    }

    if(inserir == true){
      idPontoIgual = null;
      for (let i = 0; i < pontos.length; i++) {
        if(`${pontos[i].logradouro}, ${pontos[i].numNaRua}`
        == browser.value){
          idPontoIgual = pontos[i].idPonto;
          break;
        }
      }
      vetorPonto.push({idPonto: idPontoIgual,
                       logr: browser.value});
    }
    else{
      alert("Ponto já adicionado")
    }
    

    browser.value = ``;

    pontosAdicionados.innerHTML = ``;

    listarPontosCad();
  }

  function deletarPonto(posicao){
    delete vetorPonto[posicao];

    for(var i = 0; i < vetorPonto.length; i++){
      if(vetorPonto[i] != undefined){
        vetorPontoLimpo.push(vetorPonto[i]);
      }
    }

    vetorPonto = [];
    
    for(var i = 0; i < vetorPontoLimpo.length; i++){
        vetorPonto.push(vetorPontoLimpo[i]);
    }

    vetorPontoLimpo = [];

    pontosAdicionados.innerHTML = ``;

    listarPontosCad();
  }

  function listarPontosCad(){
    for (var i = 0; i < vetorPonto.length; i++) {
      var varAtual = vetorPonto[i].logr;
      pontosAdicionados.innerHTML += `${i+1}º - ${varAtual} - <span onclick="deletarPonto('${i}')" id="listaHover">Excluir</span><br>`
    }
  }

  function addPontoLinha(){
    for (var i = 0; i < vetorPonto.length; i++) {
      var varAtual = vetorPonto[i];

      selectPontosVetor(vetorPonto[i].logr);
      cadPontosLinha(vetorPonto[i].idPonto);
    }
  }

  function selectPontosVetor(nomePontoVetor){
    var nomePonto = nomePontoVetor;

    fetch(`/ponto/listarPorNome/${nomePontoVetor}`, {
      cache: "no-store",
    }).then(function (resposta){
      console.log("ESTOU NO THEN DO SELECTLINHA()!!!!!!!!!!!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.ID_PONTO = json.idPonto;
        });
      } else {
        console.log("Houve um erro ao tentar realizar o SELECT!!!!!!!!!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
    })
    return false;
  }

  function cadPontosLinha(vetorPontoCad){
    var idPonto = vetorPontoCad;
    var idLinha = sessionStorage.ID_LINHA;

    fetch("/linhaPonto/cadastrarPontoLinha", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({

        fkLinhaServer: idLinha,
        fkPontoServer: idPonto
      })
    }).then(function (resposta) {
      console.log("resposta: ", resposta);

      if (resposta.ok) {
        alert("Cadastro REALIZADO com Sucesso!!!")

      } else {
        throw ("Houve um ERRO ao tentar realizar o cadastro!");
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });

    return false;
    
  }

</script>