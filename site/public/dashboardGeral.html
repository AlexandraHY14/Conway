<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>775N - Dados Gerais</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/modal.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="images/icon.png" type="image/x-icon">
</head>

<body>
    <!--Começando a barra lateral das KPIs-->
    <div id="sidebar">
        <div id="KPIHorariosCheios" class="KPIAlerta">
            <span>Horário mais cheio</span>
            <p id="pHorarioCheio">19:00</p>
            <span>Média em horários cheios</span>
            <p class="alerta">7 passageiros por ponto</p>
        </div>
        <div id="KPIHorariosVazios">
            <span>Horário mais vazio</span>
            <p id="pHorarioVazio">15:00</p>
            <span>Média em horários vazios</span>
            <p>4,5 passageiros por ponto</p>
        </div>
        <div id="KPIMovimentaçãoPontos">
            <span>Ponto mais movimentado</span>
            <p id="pPontoMaisMov">7</p>
            <p id="pLogMaisMov">Av. Rebouças, 2549</p>
            <span>Ponto menos movimentado</span>
            <p id="pPontoMenosMov">2</p>
            <p id="pLogMenosMov">R. Pe. Alarico, 1412</p>
        </div>
        <div id="KPIVeiculos" class="KPIAlerta">
            <span>Horários mal aproveitados - por modelo</span>
            <p class="alerta">Básico 50%</p>
            <p>Padron 0%</p>
        </div>
    </div>
    <!--Terminada a barra lateral das KPIs-->
    <!--Início do conteúdo principal da dashboard-->
    <div id="conteudoDashboard">
        <!--Início do corpo da dashboard-->
        <div id="corpoDashboard">
            <!--Início do cabeçalho da dashboard, contendo o título da rota, suas infos. e classificação-->
            <div id="cabecalhoDashboard">
                <div id="tituloRota">
                    <h1 id="h1Codigo">775N</h1>
                    <div id="infosRota">
                        <p><i>Rota Normal</i> (10)</p>
                        <p id="pNomeIda">Term. Vila Madalena</p>
                        <p id="pNomeVolta">Rio Pequeno</p>
                    </div>
                </div>
                <div id="selecionarHorario">
                    <p>Selecionar um horário</p>
                    <div>
                        <select>
                            <option value="optN">Selecionar</option>
                            <option value="opt13">12:00</option>
                            <option value="opt19">19:00</option>
                        </select>
                        <a href="dashboardHora.html"><button>Ir</button></a>
                    </div>
                    <details>
                        <summary>?</summary>
                        Selecione um horário de saída para ver informações de dias específicos
                    </details>
                </div>
            </div>
            <!--Fim do cabeçalho da dashboard-->
            <!--Início da área do gráfico da dashboard-->
            <div id="graficoDashboard">
                <!--Esta div contém, além do gráfico, seu título e uma descrição de como visualizar-->
                <h2>Média geral dos horários da rota</h2><!--cada horário por si só.-->
                <canvas id="graficoRota"></canvas>
            </div>
            <!--Fim da área do gráfico da dashboard-->
        </div>
        <!--Fim do corpo da dashboard-->
        <!--Início da barra lateral da classificação e dos veículos nessa rota-->
        <div id="sidebarOutrosDados">
            <div id="classificacao">
                <canvas id="graficoClassific"></canvas>
                <p class="classificRuim" id="classificIdeal">Ruim</p>
                <p>Classificação da Rota</p>
                <details>
                    Nosso sistema tem três tipos de classificação para uma rota: ruim, boa e ideal; baseados no índice
                    de aproveitamento dos recursos dispostos. Rotas vazias ou extremamente superlotadas geram uma
                    classificação baixa.
                    <img class="imgSaibaMais" src="images/métrica.png" alt="">
                </details>
            </div>
            <div id="veiculosDashboard">
                <h3>Veículos</h3>
                <span>utilizados nessa rota</span>
                <div id="tabelaVeiculosDashboard">
                    <div id="tabelaVeiculosCabecalho" class="tabelaVeiculosLinha">
                        <p>Placa</p>
                        <p>Lotação</p>
                        <p>Modelo</p>
                    </div>
                </div>
                <input class="modal-state" id="modal-1" type="checkbox" />
                <div class="modal">
                    <label class="modal__bg" for="modal-1"></label>
                    <div class="modal__inner">
                        <div class="container">
                            <label class="modal__close" for="modal-1"></label>
                            <h2>Veículos</h2>
                            <select name="veiculos" id="selectVeiculos">
                                <option value="EXR-4682 Articulado 93">EXR-4682 Articulado 93</option>
                                <option value="EEL-6867 Padron 80">EEL-6867 Padron 80</option>
                                <option value="CCV-4234 Basico 70">CCV-4234 Basico 70</option>
                            </select>
                            <button class="btn">Adicionar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="containerGraficoVeiculos">
                <canvas id="graficoVeiculos"></canvas>
            </div>
            <a href="menuDashboard.html">
                < VOLTAR</a>
        </div>
        <!--Fim da barra lateral dos veículos nessa rota-->
    </div>
    <!--Fim do conteúdo principal da dashboard-->
</body>

</html>
<script>
    ///////////////////////////////////////////////
    ///////////////// Temporário //////////////////
    sessionStorage.COD_ROTA = "477P";
    ///////////////////////////////////////////////

    function verificarSessao() {
        if (sessionStorage.COD_ROTA == undefined) {
            window.location = "menuDashboard.html";
        }
    }
    verificarSessao();
    var linha = null;
    var kpis = null;
    var fluxo = null;
    var veiculos = null;
    
    var pontos
    
    veiculoRota()
    function carregarLinha() {
        fetch(`linha/listarPorCodigo/${sessionStorage.COD_ROTA}`, {
            cache: "no-store",
        })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        linha = resposta;
                        configLinha();
                        gerarGraficoOtimizacao();
                    });
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados: ${error.message}`);
            });
    }

    function carregarKPIs() {
        fetch(`linha/kpiMovLinha/${sessionStorage.COD_ROTA}`, {
            cache: "no-store",
        })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        kpis = resposta;
                        configKPI();
                    });
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados: ${error.message}`);
            });
    }
    function carregarFluxo() {
        fetch(`viagem/fluxoViagens/${sessionStorage.COD_ROTA}`, {
            cache: "no-store",
        })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        fluxo = resposta;
                        configFluxo();
                    });
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados: ${error.message}`);
            });
    }

    carregarLinha();
    carregarKPIs();
    carregarFluxo();

    var codigo = document.getElementById("h1Codigo");
    var nomeIda = document.getElementById("pNomeIda");
    var nomeVolta = document.getElementById("pNomeVolta");

    var kpiHorarioCheio = document.getElementById("pHorarioCheio");
    var kpiHorarioVazio = document.getElementById("pHorarioVazio");

    var kpiPontoMaisMov = document.getElementById("pPontoMaisMov");
    var kpiLogMaisMov = document.getElementById("pLogMaisMov");
    var kpiPontoMenosMov = document.getElementById("pPontoMenosMov");
    var kpiLogMenosMov = document.getElementById("pLogMenosMov");

    var pClassificacao = document.getElementById("classificIdeal");

    function configLinha() {
        codigo.innerHTML = linha.codLinha;
        nomeIda.innerHTML = linha.nomeLinhaIda;
        nomeVolta.innerHTML = linha.nomeLinhaVolta;
    }
    function configKPI() {
        kpiPontoMaisMov.innerHTML = kpis.idPontoMaisMov;
        kpiLogMaisMov.innerHTML = kpis.logrMaisMov;

        kpiPontoMenosMov.innerHTML = kpis.idPontoMenosMov;
        kpiLogMenosMov.innerHTML = kpis.logrMenosMov;
    }
    function configFluxo() {
        var pontos = [];
        var primeiraViagem = null;

        for (let i = 0; i < fluxo.length; i++) {
            if (primeiraViagem == null) {
                primeiraViagem = fluxo[i].fkViagem
            }
            if (fluxo[i].fkViagem != primeiraViagem) {
                break;
            }
            pontos.push(fluxo[i].logradouro);
        }
        console.log("Pontos: " + pontos);

        var viagens = [];
        var viagemAtual = null;
        for (let i = 0; i < fluxo.length; i++) {
            viagens.push();
        }
        console.log(viagens);

        gerarGraficoFluxo(pontos);
    }

    function gerarGraficoOtimizacao() {
        var otimizacao = Number(linha.pctOtimizacao);
        var areaBranca = 100 - otimizacao;

        var corClassific = "";
        var nomeClassific = "";
        if (otimizacao >= 80) {
            corClassific = "#00BF63";
            nomeClassific = "Ideal";
        }
        else if (otimizacao > 30) {
            corClassific = "#fbff1a";
            nomeClassific = "Boa";
        }
        else {
            corClassific = "#DB0300";
            nomeClassific = "Ruim";
        }

        var tituloRota = document.getElementById("tituloRota");
        tituloRota.style = "background-color: " + corClassific;
        pClassificacao.innerHTML = nomeClassific;
        pClassificacao.className = "classific" + nomeClassific;

        const classificacao = ["Otimização Atual", "Melhora possível"]
        const dadosClassfic = {
            labels: classificacao,
            datasets: [{
                backgroundColor: [corClassific, "white"],
                borderColor: ["black"],
                borderWidth: "0.5",
                data: [otimizacao, areaBranca],
                circumference: 180,
                rotation: 270
            }
            ]
        }
        const configGraficoClassific = {
            type: "doughnut",
            data: dadosClassfic,
            options: {
                aspectRatio: '1/4',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        }
        const graficoClassific = new Chart(
            document.getElementById("graficoClassific"),
            configGraficoClassific
        );
    }

    function gerarGraficoFluxo(pontos) {
        const lotacaoOnibus = 80;
        const dadosGeral = {
            labels: pontos,
            datasets: [{
                label: "12:00 (CCV-4234)",
                data: [0, 8, 12, 18.5, 24.5, 30.5, 37, 34, 25, 19]
            },
            {
                label: "15:00 (CCV-4234)",
                data: [0, 5, 8, 10, 12, 19, 24, 19, 12, 7]
            },
            {
                label: "19:00 (CCV-4234)",
                data: [15.3, 30, 37.5, 45, 53.5, 64, 61, 32.5, 25.5, 10]
            }
            ]
        }
        const configGraficoGeral = {
            type: "line",
            data: dadosGeral,
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        max: (lotacaoOnibus + 25)
                    }
                }
            }
        }
        const graficoGeral = new Chart(
            document.getElementById("graficoRota"),
            configGraficoGeral
        );
    }

    // Gráfico dos ônibus na rota
    // Todos os modelos:
    // const modelos = [
    //     "Miniônibus",
    //     "Midiônibus",
    //     "Básico",
    //     "Padron",
    //     "Articulado",
    //     "Biarticulado"
    // ]
    const modelos = [
        "Básico",
        "Padron",
    ]
    const dadosVeiculos = {
        labels: modelos,
        datasets: [{
            data: [2, 1],
            backgroundColor: ['#69503C', '#BD916E']
        }
        ]
    }
    const configGraficoVeiculos = {
        type: "pie",
        data: dadosVeiculos,
        options: {
            plugins: {
                legend: {
                    position: "bottom"
                }
            }
        }
    }
    const graficoVeiculos = new Chart(
        document.getElementById("graficoVeiculos"),
        configGraficoVeiculos
    );

    function veiculoRota() {
        fetch(`linha/veiculoRota/${sessionStorage.COD_ROTA}`)
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(response)}`);

                        var listaVeiculos = document.getElementById("tabelaVeiculosDashboard");
                        for (let i = 0; i < resposta.length; i++) {
                            var veiculo = document.createElement("div");
                            var placa = document.createElement("p");
                            var lotacao = document.createElement("p");
                            var modelo = document.createElement("p");

                            placa.innerHTML = resposta[i].placaVeiculo;
                            lotacao.innerHTML = resposta[i].lotacao;
                            modelo.innerHTML = resposta[i].nomeModelo;

                            veiculo.appendChild(placa);
                            veiculo.appendChild(lotacao);
                            veiculo.appendChild(modelo);
                            veiculo.className = 'tabelaVeiculosLinha';

                            listaVeiculos.appendChild(veiculo);

                        }
                    });
                } else {
                    console.error("Nenhum dado encontrado na API");
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados: ${error.message}`);
            });
    }

</script>