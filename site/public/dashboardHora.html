<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>775N - 12:00</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="images/icon.png" type="image/x-icon">
</head>
<body>
    <!--Começando a barra lateral das KPIs-->
    <div id="sidebar" class="sidebarHora">
        <div id="KPIDias">
            <span>Dia Mais Cheio:</span>
            <p>Segunda-Feira</p>
            <span>Dia Mais Vazio:</span>
            <p>Sábado</p>
        </div>
        <div id="KPIMovimentaçãoPontos">
            <span>Ponto de Maior Pico</span>
            <p>7</p>
            <p>Av. Rebouças, 2549</p>
            <span>Ponto de Menor Pico</span>
            <p>3</p>
            <p>Av. Eng. Heitor, 1421</p>
        </div>
    </div>
    <!--Terminada a barra lateral das KPIs-->
    <!--Início do conteúdo principal da dashboard-->
    <div id="conteudoDashboard">
        <!--Início do corpo da dashboard-->
        <div id="corpoDashboard">
            <!--Início do cabeçalho da dashboard, contendo o título da rota, suas infos. e classificação-->
            <div id="cabecalhoDashboard">
                <div id="tituloRota">
                    <h1 id="h1Codigo"></h1>
                    <div id="infosRota">
                        <p id="pNomeIda"></p>
                        <p id="pNomeVolta"></p>
                        <p id="pTipoRota"></p>
                    </div>
                </div>
                <div id="dicaDias">
                    Clique em um dos dias na legenda para ocultá-lo, facilitando a visualização dos demais. Para exibi-lo
                    novamente, basta clicá-lo que ele volta a aparecer no gráfico.  
                </div>
            </div>
            <!--Fim do cabeçalho da dashboard-->
            <!--Início da área do gráfico da dashboard-->
            <div id="graficoDashboard"><!--Esta div contém, além do gráfico, seu título e uma descrição de como visualizar-->
                <h2 id="titHorario"></h2><!--cada horário por si só.-->
                <canvas id="graficoRota"></canvas>
            </div>
            <!--Fim da área do gráfico da dashboard-->
        </div>
        <!--Fim do corpo da dashboard-->
        <!--Início da barra lateral da classificação e dos veículos nessa rota-->
            <div id="sidebarOutrosDados">
                <div id="classificacao">
                    <p class="classificIdeal" id="classific">Boa</p>
                    <canvas id="graficoClassific"></canvas>
                    <p>Classificação da hora</p>
                </div>
                <details id="detailsFormula">
                    Fórmula utilizada:
                    <img class="imgSaibaMais" src="images/formula busway.png" onclick="mostrarFormula(true)">
                    (Clique para ampliar)
                </details>
                <div id="veiculosDashboard">
                    <h3>Veículos</h3>
                    <span>utilizados nesse horário</span>
                    <div id="tabelaVeiculosDashboard">
                        <div id="tabelaVeiculosCabecalho" class="tabelaVeiculosLinha">
                           <p>Placa</p>
                            <p>Lotação</p>
                            <p>Modelo</p>
                        </div>
                        <div class="tabelaVeiculosLinha">
                            <p>EEL-6867</p>
                            <p>70</p>
                            <p>Básico</p>
                        </div>
                        <div class="tabelaVeiculosLinha">
                            <p>EXR-4682</p>
                            <p>80</p>
                            <p>Padron</p>
                        </div>
                    </div>
                </div>
                <div id="containerGraficoVeiculos">
                    <canvas id="graficoVeiculos"></canvas>
                </div>
                <a href="dashboardGeral.html">< VOLTAR</a>
            </div>
            <!--Fim da barra lateral dos veículos nessa rota-->
    </div>
    <!--Fim do conteúdo principal da dashboard-->
    <div id="modalFormula">
        <svg xmlns="http://www.w3.org/2000/svg" height="2em" viewBox="0 0 384 512" fill="#69503C" onclick="mostrarFormula(false)">
            <path d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/>
        </svg>
        <img src="images/formula busway.png">
    </div>
</body>
</html>
<script>
    if(sessionStorage.HORARIO_DA_LINHA == undefined){
        window.location.href = "menuDashboard.html";
    }
    else{
        // alert(sessionStorage.HORARIO_DA_LINHA);
    }
    var horario = sessionStorage.HORARIO_DA_LINHA;
    var linha = null;
    var otimizacaoHorario = null;
    var kpiMov = null;
    var kpiHor = null;
    var fluxo = null;
    var pontos = null;
    var veiculos = null;

    function mostrarFormula(mostrar){
        if(mostrar){
            modalFormula.style = "visibility: visible";
        }
        else{
            modalFormula.style = "visibility: hidden";
        }
    }

    function carregarLinha() {
        fetch(`linha/listarPorCodigo/${sessionStorage.COD_ROTA}`, {
            cache: "no-store",
        }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
            console.log(`Linha: ${JSON.stringify(resposta)}`);
            linha = resposta;
            configLinha();
        });
        }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    function carregarOtimizacao() {
        fetch(`/viagem/otimizacaoHorario/${sessionStorage.COD_ROTA}/${horario}`, {
            cache: "no-store",
        }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
            console.log(`Otimização: ${JSON.stringify(resposta)}`);
            otimizacaoHorario = resposta;
            gerarGraficoOtimizacao();
        });
        }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }

    carregarLinha();
    carregarOtimizacao();

    var codigo = document.getElementById("h1Codigo");
    var nomeIda = document.getElementById("pNomeIda");
    var nomeVolta = document.getElementById("pNomeVolta");
    var tipoRota = document.getElementById("pTipoRota");

    var tituloHorario = document.getElementById("titHorario");

    var pClassificacao = document.getElementById("classific");

    function configLinha(){
        document.title = `${linha.codLinha} - Dados gerais`;
        codigo.innerHTML = linha.codLinha;
        nomeIda.innerHTML = linha.nomeLinhaIda;
        nomeVolta.innerHTML = linha.nomeLinhaVolta;

        tituloHorario.innerHTML = `Média do horário das ${horario}`;
        
        var codTipoLinha = linha.tipoLinha;
        var transcTipoLinha = null; //Transcreve o tipo da linha baseado no código desse tipo
        if(codTipoLinha == 10){
            transcTipoLinha = "normal";
        }
        else if(codTipoLinha == 11){
            transcTipoLinha = "noturna";
        }
        else if(codTipoLinha > 20 && codTipoLinha < 30){
            transcTipoLinha = "retorno";
        }
        else if(codTipoLinha < 40){
            transcTipoLinha = "derivição";
        } 
        else if(codTipoLinha < 50){
            transcTipoLinha = "bifurcação";
        }
        else if(codTipoLinha < 60){
            transcTipoLinha = "prolongamento";
        }

        if(transcTipoLinha != null){
            pTipoRota.innerHTML = `<i>Rota ${transcTipoLinha}</i> (${codTipoLinha})`;
        }
    }

    function gerarGraficoOtimizacao() {
        var otimizacao = Number(otimizacaoHorario[0].otimizacao);
        var areaBranca = 100 - otimizacao;

        var corClassific = "";
        var nomeClassific = "";
        if (otimizacao >= 80) {
            corClassific = "#00BF63";
            nomeClassific = "Ideal";
        }
        else if (otimizacao > 30) {
            corClassific = "#fbff1a";
            nomeClassific = "Boa";
        }
        else {
            corClassific = "#DB0300";
            nomeClassific = "Ruim";
        }

        var tituloRota = document.getElementById("tituloRota");
        tituloRota.style = "background-color: "+corClassific;
        pClassificacao.innerHTML = nomeClassific;
        pClassificacao.className = "classific" + nomeClassific;

        const classificacao = ["Otimização Atual","Melhora possível"]
        const dadosClassfic = {
            labels: classificacao,
            datasets: [{
                    backgroundColor: [corClassific,"white"],
                    borderColor: ["black"],
                    borderWidth: "0.5",
                    data: [otimizacao,areaBranca],
                    circumference: 180,
                    rotation: 270
                }
            ]
        }
        const configGraficoClassific = {
            type: "doughnut",
            data: dadosClassfic,
            options: {
                aspectRatio: '1/4',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        }
        const graficoClassific = new Chart(
            document.getElementById("graficoClassific"),
            configGraficoClassific
        );
    }

    //Gráfico geral da rota
    const lotacaoOnibus = 70;
    const dadosHora = {
        labels:pontos,
        datasets: [{
                label: "06/01, seg.",
                data: [10,15,22,28,35,42,46,49,54,59,64,58,50,39,30,24,13]
            },
            {
                label: "07/01, ter.",
                data: [8,13,20,25,32,36,40,43,50,53,60,53,49,40,36,29,18]
            },
            {
                label: "08/01, qua.",
                data: [10,15,22,28,35,42,46,49,54,59,64,58,50,39,30,24,13]
            },
            {
                label: "09/01, qui.",
                data: [8,15,20,27,32,39,45,49,54,58,64,57,50,44,39,27,16]
            },
            {
                label: "10/01, sex.",
                data: [12,19,27,30,39,45,53,60,64,70,73,71,76,69,60,53,47]
            },
            {
                label: "11/01, sab.",
                data: [2,0,4,8,12,16,17,17,20,21,20,23,23,18,14,8,4]
            },
        ]
    }
    const configGraficoGeral = {
        type: "line",
        data: dadosHora,
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    max: (lotacaoOnibus +25)
            }
            }
        }
    }
    const graficoGeral = new Chart(
        document.getElementById("graficoRota"),
        configGraficoGeral
    );

    // Gráfico dos ônibus na rota
    // Todos os modelos:
    // const modelos = [
    //     "Miniônibus",
    //     "Midiônibus",
    //     "Básico",
    //     "Padron",
    //     "Articulado",
    //     "Biarticulado"
    // ]
     const modelos = [
         "Básico",
         "Padron",
    ]
    const dadosVeiculos = {
        labels:modelos,
        datasets: [{
                data: [2,1],
                backgroundColor: ['#69503C','#BD916E']
            }
        ]
    }
    const configGraficoVeiculos = {
        type: "pie",
        data: dadosVeiculos,
        options: {
            plugins: {
                legend: {
                    position: "bottom"
                }
            }
        }
    }
    const graficoVeiculos = new Chart(
        document.getElementById("graficoVeiculos"),
        configGraficoVeiculos
    );
</script>