<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>775N - Dados Gerais</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/modal.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="images/icon.png" type="image/x-icon">
</head>
<body>
    <!--Começando a barra lateral das KPIs-->
    <div id="sidebar">
        <div id="KPIHorariosCheios" class="KPIAlerta">
            <span>Horário mais cheio</span>
            <p id="pHrCheio"></p>
            <span>Média em horários cheios</span>
            <p id="pMediaPassHrCheio" class="alerta"></p>
        </div>
        <div id="KPIHorariosVazios">
            <span>Horário mais vazio</span>
            <p id="pHrVazio"></p>
            <span>Média em horários vazios</span>
            <p id="pMediaPassHrVazio"></p>
        </div>
        <div id="KPIMovMais">
            <span>Ponto mais movimentado</span>
            <p id="pPontoMaisMov"></p>
            <p id="pLogMaisMov"></p>
        </div>
        <div id="KPIMovMenos">
            <span>Ponto menos movimentado</span>
            <p id="pPontoMenosMov"></p>
            <p id="pLogMenosMov"></p>
        </div>
    </div>
    <!--Terminada a barra lateral das KPIs-->
    <!--Início do conteúdo principal da dashboard-->
    <div id="conteudoDashboard">
        <!--Início do corpo da dashboard-->
        <div id="corpoDashboard">
            <!--Início do cabeçalho da dashboard, contendo o título da rota, suas infos. e classificação-->
            <div id="cabecalhoDashboard">
                <div id="tituloRota">
                    <h1 id="h1Codigo"></h1>
                    <div id="infosRota">
                        <p id="pTipoRota"></p>
                        <p id="pNomeIda"></p>
                        <p id="pNomeVolta"></p>
                    </div>
                </div>
                <div id="selecionarHorario">
                    <p>Selecionar um horário</p>
                    <div>
                        <select>
                            <option value="optN">Selecionar</option>
                            <option value="opt13">12:00</option>
                            <option value="opt19">19:00</option>
                        </select>
                        <a href="dashboardHora.html"><button>Ir</button></a>
                    </div>
                    <details>
                        <summary>?</summary>
                        Selecione um horário de saída para ver informações de dias específicos
                    </details>
                </div>
            </div>
            <!--Fim do cabeçalho da dashboard-->
            <!--Início da área do gráfico da dashboard-->
            <div id="graficoDashboard"><!--Esta div contém, além do gráfico, seu título e uma descrição de como visualizar-->
                <h2>Média geral dos horários da rota</h2><!--cada horário por si só.-->
                <canvas id="graficoRota"></canvas>
            </div>
            <!--Fim da área do gráfico da dashboard-->
        </div>
        <!--Fim do corpo da dashboard-->
        <!--Início da barra lateral da classificação e dos veículos nessa rota-->
            <div id="sidebarOutrosDados">
                <div id="classificacao">
                    <canvas id="graficoClassific"></canvas>
                    <p class="classificRuim" id="classific"></p>
                    <p>Classificação da Rota</p>
                </div>
                <details>
                    Nosso sistema tem três tipos de classificação para uma rota: ruim, boa e ideal; baseados no índice 
                    de aproveitamento dos recursos dispostos. Rotas vazias ou extremamente superlotadas geram uma 
                    classificação baixa.
                    <img class="imgSaibaMais" src="images/métrica.png" alt="">
                </details>
                <div id="veiculosDashboard">
                    <h3>Veículos</h3>
                    <span>utilizados nessa rota</span>
                    <div id="tabelaVeiculosDashboard">
                        <div id="tabelaVeiculosCabecalho" class="tabelaVeiculosLinha">
                           <p>Placa</p>
                            <p>Lotação</p>
                            <p>Modelo</p>
                        </div>
                        <div class="tabelaVeiculosLinha">
                            <p>CCV-4234</p>
                            <p>70</p>
                            <p>Básico</p>
                        </div>
                        <div class="tabelaVeiculosLinha">
                            <p>EEL-6867</p>
                            <p>70</p>
                            <p>Básico</p>
                        </div>
                        <div class="tabelaVeiculosLinha">
                            <p>EXR-4682</p>
                            <p>80</p>
                            <p>Padron</p>
                        </div>
                    </div>
                </div>
                <div id="containerGraficoVeiculos">
                    <canvas id="graficoVeiculos"></canvas>
                </div>
                <a href="menuDashboard.html">< VOLTAR</a>
            </div>
            <!--Fim da barra lateral dos veículos nessa rota-->
    </div>
    <!--Fim do conteúdo principal da dashboard-->
</body>
</html>
<script>
    ///////////////////////////////////////////////
    ///////////////// Temporário //////////////////
    sessionStorage.COD_ROTA = "477P";
    ///////////////////////////////////////////////
    
    function verificarSessao() {
        if (sessionStorage.COD_ROTA == undefined) {
            window.location = "menuDashboard.html";
        }
    }
    verificarSessao();
 
    var linha = null;
    var kpis = null;
    var fluxo = null;
    var horarios = null;
    var pontos = null;
    var veiculos = null;

    var pontos

    function carregarLinha() {
        fetch(`linha/listarPorCodigo/${sessionStorage.COD_ROTA}`, {
        cache: "no-store",
        })
        .then(function (response) {
            if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Linha: ${JSON.stringify(resposta)}`);
                linha = resposta;
                configLinha();
                gerarGraficoOtimizacao();
            });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    function carregarKPIs() {
        fetch(`linha/kpiMovLinha/${sessionStorage.COD_ROTA}`, {
        cache: "no-store",
        })
        .then(function (response) {
            if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`KPI pontos +/- movimentados: ${JSON.stringify(resposta)}`);
                kpis = resposta;
                configKPIMovLinha();
            });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });

        fetch(`viagem/mediaPassageirosPorHorario/${sessionStorage.COD_ROTA}`, {
        cache: "no-store",
        })
        .then(function (response) {
            if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`KPI média de passageiros por horário: ${JSON.stringify(resposta)}`);
                kpis = resposta;
                configKPIMediaPass();
            });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    function carregarhorarios() {
        fetch(`viagem/horariosPorRota/${sessionStorage.COD_ROTA}`, {
        cache: "no-store",
        })
        .then(function (response) {
            if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`horarios: ${JSON.stringify(resposta)}`);
                horarios = resposta;
                confighorarios();
                carregarPontos();
            });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    function carregarPontos() {
        fetch(`ponto/listarPorCodLinha/${sessionStorage.COD_ROTA}`, {
        cache: "no-store",
        })
        .then(function (response) {
            if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Pontos: ${JSON.stringify(resposta)}`);
                pontos = resposta;
                configPontos();
                carregarFluxo();
            });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    function carregarFluxo() {
        fetch(`viagem/fluxoViagens/${sessionStorage.COD_ROTA}`, {
        cache: "no-store",
        })
        .then(function (response) {
            if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Fluxo: ${JSON.stringify(resposta)}`);
                fluxo = resposta;
                configFluxo();
            });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    
    carregarLinha();
    carregarKPIs();
    carregarhorarios();

    var codigo = document.getElementById("h1Codigo");
    var nomeIda = document.getElementById("pNomeIda");
    var nomeVolta = document.getElementById("pNomeVolta");
    var tipoRota = document.getElementById("pTipoRota");

    var kpiPontoMaisMov = document.getElementById("pPontoMaisMov");
    var kpiLogMaisMov = document.getElementById("pLogMaisMov");
    var kpiPontoMenosMov = document.getElementById("pPontoMenosMov");
    var kpiLogMenosMov = document.getElementById("pLogMenosMov");

    var kpiHrCheio = document.getElementById("pHrCheio");
    var kpiMediaPassHrCheio = document.getElementById("pMediaPassHrCheio");
    var kpiHrCheio = document.getElementById("pHrVazio");
    var kpiMediaPassHrCheio = document.getElementById("pMediaPassHrVazio");

    var pClassificacao = document.getElementById("classific");

    function configLinha(){
        codigo.innerHTML = linha.codLinha;
        nomeIda.innerHTML = linha.nomeLinhaIda;
        nomeVolta.innerHTML = linha.nomeLinhaVolta;
        
        var codTipoLinha = linha.tipoLinha;
        var transcTipoLinha = null; //Transcreve o tipo da linha baseado no código desse tipo
        if(codTipoLinha == 10){
            transcTipoLinha = "normal";
        }
        else if(codTipoLinha == 11){
            transcTipoLinha = "noturna";
        }
        else if(codTipoLinha > 20 && codTipoLinha < 30){
            transcTipoLinha = "retorno";
        }
        else if(codTipoLinha < 40){
            transcTipoLinha = "derivição";
        }
        else if(codTipoLinha < 50){
            transcTipoLinha = "bifurcação";
        }
        else if(codTipoLinha < 60){
            transcTipoLinha = "prolongamento";
        }

        if(transcTipoLinha != null){
            pTipoRota.innerHTML = `<i>Rota ${transcTipoLinha}</i> (${codTipoLinha})`;
        }
    }
    function configKPIMovLinha(){   
        kpiPontoMaisMov.innerHTML = kpis.idPontoMaisMov;
        kpiLogMaisMov.innerHTML = kpis.logrMaisMov;

        kpiPontoMenosMov.innerHTML = kpis.idPontoMenosMov;
        kpiLogMenosMov.innerHTML = kpis.logrMenosMov;
    }
    function configKPIMediaPass(){
        var cheio = {};
        var vazio = {};
        
        kpiHorarioCheio.innerHTML = cheio.horario;
        // kpiHorarioCheio
        //----------------------------------------------------------------------
        //----------------------------------------------------------------------
        //----------------------------- PARA FAZER -----------------------------
        //----------------------------------------------------------------------
        //----------------------------------------------------------------------
    }
    
    function confighorarios(){

    }

    var logs = [];
    function configPontos(){
        for (let i = 0; i < pontos.length; i++) {
            if(pontos[i].numNaRua != undefined){
                logs[i] = `${i + 1} - ${pontos[i].logradouro}, ${pontos[i].numNaRua}`;
            }
            else{
                logs[i] = `${i + 1} - ${pontos[i].logradouro}`;
            }
        }
    }

    // [{ -- Formato entendido pelo CHART.JS, para referência
    //     label: "12:00 (CCV-4234)" ,
    //     data: [0,8,12,18.5,24.5,30.5,37,34,25,19]
    // }]
    var fluxoTratado = [];
    function configFluxo(){
        for (let i = 0; i < horarios.length; i++) {
            let data = [];
            for (let c = 0; c < fluxo.length; c++) {
                if(fluxo[c].horario == horarios[i].horario){
                    data.push(fluxo[c].saldoPassageiros);
                }
            }
            var horarioFluxo = (horarios[i].horario);
            fluxoTratado.push({label: horarioFluxo, data});
        }
        gerarGraficoFluxo(logs, fluxoTratado);
    }

    function gerarGraficoOtimizacao(){
        var otimizacao = Number(linha.pctOtimizacao);
        var areaBranca = 100 - otimizacao;
        
        var corClassific = "";
        var nomeClassific = "";
        if(otimizacao >= 80){
            corClassific = "#00BF63";
            nomeClassific = "Ideal";
        }
        else if(otimizacao > 30){
            corClassific = "#fbff1a";
            nomeClassific = "Boa";
        }
        else{
            corClassific = "#DB0300";
            nomeClassific = "Ruim";
        }

        var tituloRota = document.getElementById("tituloRota");
        tituloRota.style = "background-color: "+corClassific;
        pClassificacao.innerHTML = nomeClassific;
        pClassificacao.className = "classific" + nomeClassific;

        const classificacao = ["Otimização Atual","Melhora possível"]
        const dadosClassfic = {
            labels: classificacao,
            datasets: [{
                    backgroundColor: [corClassific,"white"],
                    borderColor: ["black"],
                    borderWidth: "0.5",
                    data: [otimizacao,areaBranca],
                    circumference: 180,
                    rotation: 270
                }
            ]
        }
        const configGraficoClassific = {
            type: "doughnut",
            data: dadosClassfic,
            options: {
                aspectRatio: '1/4',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        }
        const graficoClassific = new Chart(
            document.getElementById("graficoClassific"),
            configGraficoClassific
        );
    }

    function gerarGraficoFluxo(pLogs, pFluxo){
        const lotacaoOnibus = 80;
        const dadosGeral = {
            labels: pLogs,
            datasets: pFluxo
        }
        const configGraficoGeral = {
            type: "line",
            data: dadosGeral,
            options: {
                scales: {
                    x: { //Deixa as labels do eixo X (pontos) na vertical
                        ticks: {
                            maxRotation: 90,
                            minRotation: 90
                        }
                    }
                }
            }
        }
        const graficoGeral = new Chart(
            document.getElementById("graficoRota"),
            configGraficoGeral
        );
    }

    // Gráfico dos ônibus na rota
    // Todos os modelos:
    // const modelos = [
    //     "Miniônibus",
    //     "Midiônibus",
    //     "Básico",
    //     "Padron",
    //     "Articulado",
    //     "Biarticulado"
    // ]
     const modelos = [
         "Básico",
         "Padron",
    ]
    const dadosVeiculos = {
        labels:modelos,
        datasets: [{
                data: [2,1],
                backgroundColor: ['#69503C','#BD916E']
            }
        ]
    }
    const configGraficoVeiculos = {
        type: "pie",
        data: dadosVeiculos,
        options: {
            plugins: {
                legend: {
                    position: "bottom"
                }
            }
        }
    }
    const graficoVeiculos = new Chart(
        document.getElementById("graficoVeiculos"),
        configGraficoVeiculos
    );
</script>